<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HERS - Emergency Routing System</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap');
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Inter', sans-serif;
            background: #0a0e27;
            color: #fff;
            overflow: hidden;
        }
        
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(45deg, #E31E24, #8B0000, #FF0000, #DC143C);
            background-size: 400% 400%;
            animation: gradientShift 15s ease infinite;
            opacity: 0.15;
            z-index: -1;
        }
        
        @keyframes gradientShift {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }
        
        .header {
            background: rgba(10, 14, 39, 0.95);
            backdrop-filter: blur(20px);
            padding: 25px 40px;
            border-bottom: 1px solid rgba(227, 30, 36, 0.4);
            box-shadow: 0 4px 30px rgba(227, 30, 36, 0.3);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .header-left h1 {
            font-size: 28px;
            font-weight: 700;
            background: linear-gradient(135deg, #E31E24, #FF4444);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 5px;
        }
        
        .header-left p {
            font-size: 13px;
            color: #a0a0c0;
            font-weight: 300;
        }
        
        .status-badges { display: flex; gap: 15px; }
        
        .badge {
            background: rgba(227, 30, 36, 0.2);
            border: 1px solid rgba(227, 30, 36, 0.5);
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
            backdrop-filter: blur(10px);
        }
        
        .badge-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #E31E24;
            animation: pulse 2s infinite;
            box-shadow: 0 0 10px #E31E24;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(1.2); }
        }
        
        .container {
            display: grid;
            grid-template-columns: 380px 1fr;
            height: calc(100vh - 90px);
        }
        
        .sidebar {
            background: rgba(10, 14, 39, 0.9);
            backdrop-filter: blur(20px);
            padding: 25px;
            overflow-y: auto;
            border-right: 1px solid rgba(227, 30, 36, 0.3);
        }
        
        .sidebar::-webkit-scrollbar { width: 6px; }
        .sidebar::-webkit-scrollbar-track { background: rgba(255, 255, 255, 0.05); }
        .sidebar::-webkit-scrollbar-thumb { background: rgba(227, 30, 36, 0.6); border-radius: 3px; }
        
        .section { margin-bottom: 30px; }
        
        .section-title {
            font-size: 14px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            color: #E31E24;
            margin-bottom: 18px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .section-title::before {
            content: '';
            width: 4px;
            height: 16px;
            background: linear-gradient(180deg, #E31E24, #FF4444);
            border-radius: 2px;
        }
        
        .btn {
            width: 100%;
            padding: 14px 20px;
            margin: 10px 0;
            border: none;
            border-radius: 12px;
            background: linear-gradient(135deg, rgba(227, 30, 36, 0.8), rgba(180, 24, 29, 0.8));
            color: white;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(227, 30, 36, 0.4);
        }
        
        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            transition: left 0.5s;
        }
        
        .btn:hover::before { left: 100%; }
        .btn:hover { transform: translateY(-3px); box-shadow: 0 8px 25px rgba(227, 30, 36, 0.6); }
        .btn:active { transform: translateY(-1px); }
        
        .btn-hospital {
            background: linear-gradient(135deg, rgba(139, 0, 0, 0.8), rgba(220, 20, 60, 0.8));
            box-shadow: 0 4px 15px rgba(139, 0, 0, 0.4);
        }
        .btn-hospital:hover { box-shadow: 0 8px 25px rgba(139, 0, 0, 0.6); }
        
        .btn-ambulance {
            background: linear-gradient(135deg, rgba(227, 30, 36, 0.7), rgba(255, 68, 68, 0.7));
            box-shadow: 0 4px 15px rgba(227, 30, 36, 0.4);
        }
        .btn-ambulance:hover { box-shadow: 0 8px 25px rgba(227, 30, 36, 0.6); }
        
        .btn-emergency {
            background: linear-gradient(135deg, rgba(227, 30, 36, 0.95), rgba(255, 0, 0, 0.95));
            box-shadow: 0 4px 15px rgba(227, 30, 36, 0.5);
            font-size: 16px;
            padding: 18px;
            animation: emergencyPulse 2s infinite;
        }
        
        @keyframes emergencyPulse {
            0%, 100% { box-shadow: 0 4px 15px rgba(227, 30, 36, 0.5); }
            50% { box-shadow: 0 4px 25px rgba(227, 30, 36, 0.9), 0 0 30px rgba(227, 30, 36, 0.5); }
        }
        
        .btn-emergency:hover { box-shadow: 0 8px 35px rgba(227, 30, 36, 0.8); }
        
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        
        .stat-card {
            background: rgba(227, 30, 36, 0.15);
            border: 1px solid rgba(227, 30, 36, 0.4);
            padding: 15px;
            border-radius: 12px;
            backdrop-filter: blur(10px);
            transition: all 0.3s;
        }
        
        .stat-card:hover {
            background: rgba(227, 30, 36, 0.25);
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(227, 30, 36, 0.3);
        }
        
        .stat-label {
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: #a0a0c0;
            margin-bottom: 8px;
        }
        
        .stat-value {
            font-size: 24px;
            font-weight: 700;
            background: linear-gradient(135deg, #E31E24, #FF4444);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        #map { height: 100%; width: 100%; }
        
        .info-panel {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(10, 14, 39, 0.95);
            backdrop-filter: blur(30px);
            padding: 25px;
            border-radius: 16px;
            max-width: 400px;
            z-index: 1000;
            box-shadow: 0 8px 40px rgba(227, 30, 36, 0.4);
            border: 1px solid rgba(227, 30, 36, 0.4);
            display: none;
            animation: slideIn 0.3s ease-out;
        }
        
        @keyframes slideIn {
            from { opacity: 0; transform: translateX(50px); }
            to { opacity: 1; transform: translateX(0); }
        }
        
        .info-panel.active { display: block; }
        
        .info-panel h3 { color: #E31E24; margin-bottom: 20px; font-size: 18px; font-weight: 700; }
        
        .info-item {
            margin: 12px 0;
            padding: 15px;
            background: rgba(227, 30, 36, 0.1);
            border-left: 3px solid #E31E24;
            border-radius: 8px;
            font-size: 13px;
            line-height: 1.6;
        }
        
        .close-btn {
            position: absolute;
            top: 15px;
            right: 15px;
            background: rgba(227, 30, 36, 0.3);
            border: 1px solid rgba(227, 30, 36, 0.6);
            color: #fff;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 18px;
            transition: all 0.3s;
        }
        
        .close-btn:hover { background: rgba(227, 30, 36, 0.6); transform: rotate(90deg); }
        
        .legend {
            background: rgba(227, 30, 36, 0.1);
            border: 1px solid rgba(227, 30, 36, 0.4);
            padding: 18px;
            border-radius: 12px;
            font-size: 12px;
        }
        
        .legend-item { display: flex; align-items: center; margin: 12px 0; transition: all 0.2s; }
        .legend-item:hover { transform: translateX(5px); }
        .legend-icon { font-size: 20px; margin-right: 12px; filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.3)); }
        .loading { text-align: center; padding: 20px; color: #E31E24; font-weight: 600; }
        
        .leaflet-popup-content-wrapper {
            background: rgba(10, 14, 39, 0.95);
            color: #fff;
            border: 1px solid rgba(227, 30, 36, 0.6);
            border-radius: 12px;
            backdrop-filter: blur(20px);
        }
        
        .leaflet-popup-tip { background: rgba(10, 14, 39, 0.95); }
        .leaflet-popup-content { margin: 15px; font-size: 13px; line-height: 1.6; }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-left">
            <h1>üöë HERS - Healthcare Emergency Routing System</h1>
            <p>Real-time Emergency Response for Karachi | Powered by Java & GraphHopper</p>
        </div>
        <div class="status-badges">
            <div class="badge"><div class="badge-dot"></div><span id="system-status">Online</span></div>
            <div class="badge"><span>üó∫Ô∏è <strong id="node-count">-</strong> nodes</span></div>
            <div class="badge"><span>üè• <strong id="hospital-count">-</strong> hospitals</span></div>
            <div class="badge"><span>üöë <strong id="ambulance-count">-</strong> ambulances</span></div>
        </div>
    </div>
    
    <div class="container">
        <div class="sidebar">
            <div class="section">
                <div class="section-title">Quick Actions</div>
                <button class="btn btn-emergency" onclick="dispatchAmbulance()">üö® Emergency Dispatch</button>
            </div>
            
            <div class="section">
                <div class="section-title">Visualizations</div>
                <button class="btn btn-hospital" onclick="showHospitals()">üè• Show All Hospitals</button>
                <button class="btn btn-ambulance" onclick="showAmbulances()">üöë Show Ambulance Fleet</button>
                <button class="btn" onclick="findNearestHospital()">üìç Find Nearest Hospital</button>
                <button class="btn" onclick="clearMap()">üóëÔ∏è Clear Map</button>
            </div>
            
            <div class="section">
                <div class="section-title">System Stats</div>
                <div class="stats-grid">
                    <div class="stat-card"><div class="stat-label">Graph Nodes</div><div class="stat-value" id="node-stat">-</div></div>
                    <div class="stat-card"><div class="stat-label">Graph Edges</div><div class="stat-value" id="edge-stat">-</div></div>
                    <div class="stat-card"><div class="stat-label">Hospitals</div><div class="stat-value" id="hospital-stat">-</div></div>
                    <div class="stat-card"><div class="stat-label">Ambulances</div><div class="stat-value" id="ambulance-stat">-</div></div>
                </div>
            </div>
            
            <div class="section">
                <div class="section-title">Map Legend</div>
                <div class="legend">
                    <div class="legend-item"><span class="legend-icon">üè•</span><span>Hospitals & Medical Centers</span></div>
                    <div class="legend-item"><span class="legend-icon">üöë</span><span>Ambulances</span></div>
                    <div class="legend-item"><span class="legend-icon">üìç</span><span>Emergency Location</span></div>
                    <div class="legend-item"><span class="legend-icon">üõ£Ô∏è</span><span>Route</span></div>
                </div>
            </div>
        </div>
        
        <div style="position: relative;">
            <div id="map"></div>
            <div id="info-panel" class="info-panel"></div>
        </div>
    </div>
    
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        const API_URL = 'http://localhost:4567/api';
        const map = L.map('map').setView([24.8607, 67.0011], 12);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {attribution: '¬© OpenStreetMap'}).addTo(map);
        
        let markers = [], routeLine = null, animationInterval = null, movingAmbulance = null, currentEmergencyLocation = null;
        
        async function checkStatus() {
            try {
                const res = await fetch(`${API_URL}/status`);
                const d = await res.json();
                document.getElementById('system-status').textContent = 'Online';
                document.getElementById('node-count').textContent = (d.nodes / 1000000).toFixed(2) + 'M';
                document.getElementById('hospital-count').textContent = d.hospitals;
                document.getElementById('ambulance-count').textContent = d.ambulances;
                document.getElementById('node-stat').textContent = (d.nodes / 1000000).toFixed(2) + 'M';
                document.getElementById('edge-stat').textContent = (d.edges / 1000000).toFixed(2) + 'M';
                document.getElementById('hospital-stat').textContent = d.hospitals;
                document.getElementById('ambulance-stat').textContent = d.ambulances;
            } catch (e) {
                document.getElementById('system-status').textContent = 'Offline';
            }
        }
        
        async function showHospitals() {
            clearMap();
            showInfo('<div class="loading">Loading hospitals...</div>');
            try {
                const res = await fetch(`${API_URL}/hospitals`);
                const hospitals = await res.json();
                const bounds = L.latLngBounds();
                hospitals.forEach(h => {
                    const m = L.circleMarker([h.lat, h.lon], {radius: 10, fillColor: "#E31E24", color: "#fff", weight: 2, opacity: 1, fillOpacity: 0.8}).addTo(map);
                    m.bindPopup(`
                        <b style="color: #E31E24; font-size: 15px;">üè• ${h.name}</b><br>
                        <span style="color: #a0a0c0;">Type:</span> ${h.type}<br>
                        <span style="color: #a0a0c0;">Coordinates:</span> ${h.lat.toFixed(4)}, ${h.lon.toFixed(4)}<br>
                        <span style="color: #a0a0c0;">Emergency:</span> ${h.hasEmergency ? '‚úì Yes' : '‚úó No'}<br>
                        <span style="color: #a0a0c0;">Trauma Center:</span> ${h.hasTrauma ? '‚úì Yes' : '‚úó No'}
                    `);
                    markers.push(m);
                    bounds.extend([h.lat, h.lon]);
                });
                if (bounds.isValid()) map.fitBounds(bounds, {padding: [50, 50]});
                showInfo(`<h3>üè• Hospitals Loaded</h3><div class="info-item">Showing <strong>${hospitals.length}</strong> red circle markers on map<br>Zoom: ${map.getZoom()}<br>Click any marker for details</div>`);
            } catch (e) {
                showInfo('<h3>‚ùå Error</h3><div class="info-item">Failed to load</div>');
            }
        }
        
        async function showAmbulances() {
            clearMap();
            showInfo('<div class="loading">Loading ambulances...</div>');
            try {
                const res = await fetch(`${API_URL}/ambulances`);
                const ambulances = await res.json();
                const bounds = L.latLngBounds();
                const groups = {};
                ambulances.forEach(a => {
                    const k = `${a.lat},${a.lon}`;
                    if (!groups[k]) groups[k] = {lat: a.lat, lon: a.lon, station: a.station, ambulances: []};
                    groups[k].ambulances.push(a);
                });
                Object.values(groups).forEach(s => {
                    const t = s.ambulances.length, av = s.ambulances.filter(a => a.available).length;
                    let c = av === 0 ? '#95a5a6' : av < t ? '#ffd60a' : t >= 3 ? '#06ffa5' : '#06d68a';
                    const m = L.circleMarker([s.lat, s.lon], {radius: 12 + t * 2, fillColor: c, color: '#fff', weight: 3, opacity: 1, fillOpacity: 0.85}).addTo(map);
                    
                    let popupHTML = `
                        <div style="max-height: 300px; overflow-y: auto;">
                            <b style="color: ${c}; font-size: 16px;">üìç ${s.station}</b><br>
                            <span style="color: #a0a0c0;">Total Ambulances: <strong>${t}</strong></span><br>
                            <span style="color: #06ffa5;">Available: ${av}</span> | 
                            <span style="color: #95a5a6;">Busy: ${t - av}</span>
                            <hr style="border-color: rgba(227, 30, 36, 0.3); margin: 10px 0;">
                    `;
                    
                    s.ambulances.forEach((a, i) => {
                        const statusColor = a.available ? '#06ffa5' : '#95a5a6';
                        const statusIcon = a.available ? '‚úì' : '‚úó';
                        popupHTML += `
                            <div style="margin: 8px 0; padding: 8px; background: rgba(227, 30, 36, 0.1); border-radius: 6px;">
                                <b style="color: ${statusColor};">üöë ${a.id}</b> ${statusIcon}<br>
                                <span style="font-size: 11px; color: #a0a0c0;">
                                    Type: ${a.type} | Status: ${a.status}
                                </span>
                            </div>
                        `;
                    });
                    
                    popupHTML += `</div>`;
                    m.bindPopup(popupHTML);
                    
                    const tooltipHTML = `
                        <div style="background: rgba(10, 14, 39, 0.98); padding: 10px; border-radius: 8px; border: 1px solid ${c};">
                            <b style="color: ${c};">üìç ${s.station}</b><br>
                            <span style="font-size: 12px; color: #a0a0c0;">
                                ${t} ambulance${t > 1 ? 's' : ''}<br>
                                üü¢ ${av} available | ‚ö´ ${t - av} busy
                            </span>
                        </div>
                    `;
                    
                    m.bindTooltip(tooltipHTML, {
                        permanent: false,
                        direction: 'top',
                        offset: [0, -10],
                        className: 'custom-tooltip'
                    });
                    
                    m.on('mouseover', function() {
                        this.setStyle({
                            radius: (12 + (t * 2)) * 1.3,
                            weight: 4,
                            fillOpacity: 1
                        });
                        this.openTooltip();
                    });
                    
                    m.on('mouseout', function() {
                        this.setStyle({
                            radius: 12 + (t * 2),
                            weight: 3,
                            fillOpacity: 0.85
                        });
                    });
                    
                    markers.push(m);
                    bounds.extend([s.lat, s.lon]);
                });
                if (bounds.isValid()) map.fitBounds(bounds, {padding: [50, 50]});
                
                const available = ambulances.filter(a => a.available).length;
                const busy = ambulances.length - available;
                const uniqueStations = Object.keys(groups).length;
                
                showInfo(`
                    <h3>üöë Ambulance Fleet</h3>
                    <div class="info-item">
                        <strong>Total Ambulances:</strong> ${ambulances.length}<br>
                        <strong>Stations:</strong> ${uniqueStations}<br>
                        <strong>Available:</strong> ${available} üü¢<br>
                        <strong>Busy:</strong> ${busy} ‚ö´
                    </div>
                    <div class="info-item" style="font-size: 11px;">
                        üí° <strong>Color Guide:</strong><br>
                        Bright Green = 3+ available<br>
                        Medium Green = 2 available<br>
                        Dark Green = 1 available<br>
                        Yellow = Mixed (some busy)<br>
                        Gray = All busy<br>
                        Bigger circle = More ambulances
                    </div>
                `);
            } catch (e) {
                showInfo('<h3>‚ùå Error</h3><div class="info-item">Failed to load</div>');
            }
        }
        
        async function findNearestHospital() {
            const lat = prompt('Latitude:', '24.8200'), lon = prompt('Longitude:', '67.0300');
            if (!lat || !lon) return;
            clearMap();
            showInfo('<div class="loading">Finding nearest...</div>');
            try {
                const res = await fetch(`${API_URL}/hospitals/nearest`, {
                    method: 'POST', headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({lat: parseFloat(lat), lon: parseFloat(lon), count: 5})
                });
                const hospitals = await res.json();
                L.circleMarker([lat, lon], {radius: 15, fillColor: '#ff6b00', color: '#fff', weight: 3, opacity: 1, fillOpacity: 0.9}).addTo(map).bindPopup('<b style="color: #ff6b00;">üìç Your Location</b>');
                const bounds = L.latLngBounds([[lat, lon]]);
                let info = '<h3>üìç Nearest Hospitals</h3>';
                hospitals.forEach((h, i) => {
                    const c = ['#E31E24', '#e0005f', '#c00050', '#a00041', '#800032'][i];
                    const m = L.circleMarker([h.lat, h.lon], {radius: 12 - i, fillColor: c, color: '#fff', weight: 2, opacity: 1, fillOpacity: 0.85}).addTo(map);
                    m.bindPopup(`<b style="color: ${c};">üè• ${h.name}</b><br>Rank: #${i + 1}<br>Distance: ${(h.distance / 1000).toFixed(2)} km<br>ETA: ${h.eta.toFixed(2)} min`);
                    markers.push(m);
                    bounds.extend([h.lat, h.lon]);
                    info += `<div class="info-item" style="border-left-color: ${c};"><strong>${i + 1}. ${h.name}</strong><br>${(h.distance / 1000).toFixed(2)} km, ${h.eta.toFixed(2)} min</div>`;
                });
                showInfo(info);
                if (bounds.isValid()) map.fitBounds(bounds, {padding: [50, 50]});
            } catch (e) {
                showInfo('<h3>‚ùå Error</h3><div class="info-item">Failed</div>');
            }
        }
        
        async function dispatchAmbulance() {
            const lat = prompt('Emergency latitude:', '24.8700'), lon = prompt('Emergency longitude:', '67.0600');
            if (!lat || !lon) return;
            clearMap();
            showInfo('<div class="loading">üöë Dispatching...</div>');
            try {
                const res = await fetch(`${API_URL}/dispatch`, {
                    method: 'POST', headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({lat: parseFloat(lat), lon: parseFloat(lon)})
                });
                const r = await res.json();
                if (!r.success) return showInfo(`<h3>‚ùå Error</h3><div class="info-item">${r.error}</div>`);
                currentEmergencyLocation = {lat: parseFloat(lat), lon: parseFloat(lon)};
                const aLoc = r.path[0];
                L.circleMarker([aLoc.lat, aLoc.lon], {radius: 12, fillColor: '#06ffa5', color: '#fff', weight: 3, opacity: 1, fillOpacity: 0.9}).addTo(map).bindPopup(`<b style="color: #06ffa5;">üöë ${r.ambulanceId}</b>`);
                L.circleMarker([lat, lon], {radius: 15, fillColor: '#ff6b00', color: '#fff', weight: 3, opacity: 1, fillOpacity: 0.9}).addTo(map).bindPopup('<b style="color: #ff6b00;">üö® EMERGENCY</b>');
                const coords = r.path.map(p => [p.lat, p.lon]);
                routeLine = L.polyline(coords, {color: '#E31E24', weight: 5, opacity: 0.8}).addTo(map);
                map.fitBounds(routeLine.getBounds(), {padding: [50, 50]});
                animateAmbulance(coords, r.eta);
                showInfo(`<h3>üöë Dispatched!</h3><div class="info-item"><strong>${r.ambulanceId}</strong><br>Distance: ${(r.distance / 1000).toFixed(2)} km<br>ETA: ${r.eta.toFixed(2)} min</div>`);
                } catch (e) {
                showInfo('<h3>‚ùå Error</h3><div class="info-item">Failed</div>');
            }
        }
        
        function animateAmbulance(coords, eta) {
            movingAmbulance = L.circleMarker(coords[0], {radius: 14, fillColor: '#06ffa5', color: '#fff', weight: 4, opacity: 1, fillOpacity: 1}).addTo(map);
            let idx = 0;
            const int = 10000 / coords.length;
            animationInterval = setInterval(() => {
                idx++;
                if (idx >= coords.length) {
                    clearInterval(animationInterval);
                    movingAmbulance.bindPopup('<b style="color: #06ffa5;">üöë ARRIVED!</b>').openPopup();
                    setTimeout(showPatientIntakeForm, 1000);
                    return;
                }
                movingAmbulance.setLatLng(coords[idx]);
            }, int);
        }
        
        function showPatientIntakeForm() {
            showInfo(`<h3>üë§ Patient Assessment</h3><div class="info-item">Ambulance arrived</div>
                <form id="pf" style="margin-top: 15px;">
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; color: #a0a0c0; font-size: 12px; margin-bottom: 5px;">Name</label>
                        <input type="text" id="p-name" required style="width: 100%; padding: 10px; background: rgba(227, 30, 36, 0.1); border: 1px solid rgba(227, 30, 36, 0.3); border-radius: 8px; color: #fff; font-size: 14px;">
                    </div>
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; color: #a0a0c0; font-size: 12px; margin-bottom: 5px;">Age</label>
                        <input type="number" id="p-age" required min="0" max="150" style="width: 100%; padding: 10px; background: rgba(227, 30, 36, 0.1); border: 1px solid rgba(227, 30, 36, 0.3); border-radius: 8px; color: #fff; font-size: 14px;">
                    </div>
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; color: #a0a0c0; font-size: 12px; margin-bottom: 5px;">Emergency Type</label>
                        <select id="e-type" required style="width: 100%; padding: 10px; background: rgba(227, 30, 36, 0.1); border: 1px solid rgba(227, 30, 36, 0.3); border-radius: 8px; color: #fff; font-size: 14px;">
                            <option value="">Select...</option>
                            <option value="cardiac">üíî Cardiac</option>
                            <option value="trauma">ü©π Trauma</option>
                            <option value="stroke">üß† Stroke</option>
                            <option value="respiratory">ü´Å Respiratory</option>
                            <option value="pediatric">üë∂ Pediatric</option>
                            <option value="general">üè• General</option>
                        </select>
                    </div>
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; color: #a0a0c0; font-size: 12px; margin-bottom: 5px;">Severity</label>
                        <select id="sev" required style="width: 100%; padding: 10px; background: rgba(227, 30, 36, 0.1); border: 1px solid rgba(227, 30, 36, 0.3); border-radius: 8px; color: #fff; font-size: 14px;">
                            <option value="">Select...</option>
                            <option value="critical">üî¥ Critical</option>
                            <option value="serious">üü† Serious</option>
                            <option value="moderate">üü° Moderate</option>
                        </select>
                    </div>
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; color: #a0a0c0; font-size: 12px; margin-bottom: 5px;">Notes</label>
                        <textarea id="p-notes" rows="3" style="width: 100%; padding: 10px; background: rgba(227, 30, 36, 0.1); border: 1px solid rgba(227, 30, 36, 0.3); border-radius: 8px; color: #fff; font-size: 14px; resize: vertical;"></textarea>
                    </div>
                    <button type="submit" style="width: 100%; padding: 14px; background: linear-gradient(135deg, rgba(227, 30, 36, 0.9), rgba(139, 0, 0, 0.9)); border: none; border-radius: 12px; color: white; font-size: 15px; font-weight: 600; cursor: pointer; box-shadow: 0 4px 15px rgba(227, 30, 36, 0.4);">üè• Find Best Hospital</button>
                </form>`);
            document.getElementById('pf').addEventListener('submit', processPatient);
        }
        
        async function processPatient(e) {
            e.preventDefault();
            const pd = {name: document.getElementById('p-name').value, age: parseInt(document.getElementById('p-age').value), emergencyType: document.getElementById('e-type').value, severity: document.getElementById('sev').value, notes: document.getElementById('p-notes').value};
            showInfo('<div class="loading">Finding best hospital...</div>');
            try {
                const res = await fetch(`${API_URL}/patient/assess`, {method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({emergencyLocation: currentEmergencyLocation, patient: pd})});
                const r = await res.json();
                if (!r.success) return showInfo(`<h3>‚ùå Error</h3><div class="info-item">${r.error}</div>`);
                displayRecommendations(r.patient, r.recommendations);
            } catch (e) {
                showInfo('<h3>‚ùå Error</h3><div class="info-item">Failed</div>');
            }
        }
        
        function displayRecommendations(p, recs) {
            map.eachLayer(l => { if (l instanceof L.CircleMarker && l.options.fillColor !== '#06ffa5' && l.options.fillColor !== '#ff6b00') map.removeLayer(l); });
            const best = recs[0];
            let info = `<h3>üè• Recommendations</h3><div class="info-item" style="background: rgba(6, 255, 165, 0.1); border-color: #06ffa5;"><strong>${p.name}</strong> (${p.age})<br>${p.emergencyType} - ${p.severity}</div><div class="info-item" style="background: rgba(227, 30, 36, 0.1); border-color: #E31E24;"><strong>‚≠ê ${best.hospital.name}</strong><br>Score: ${best.score}/100<br>Distance: ${(best.distance/1000).toFixed(2)} km<br>ETA: ${best.eta.toFixed(2)} min<br><small style="color: #a0a0c0; font-style: italic;">${best.reasoning}</small></div><div style="font-size: 12px; color: #a0a0c0; margin: 10px 0;">Alternatives:</div>`;
            recs.forEach((rec, i) => {
                const c = ['#E31E24', '#e0005f', '#c00050', '#a00041'][i];
                const m = L.circleMarker([rec.hospital.lat, rec.hospital.lon], {radius: i === 0 ? 15 : 12 - i, fillColor: c, color: '#fff', weight: i === 0 ? 3 : 2, opacity: 1, fillOpacity: 0.9}).addTo(map);
                m.bindPopup(`<b style="color: ${c};">${i === 0 ? '‚≠ê ' : ''}üè• ${rec.hospital.name}</b><br>Rank: #${i+1}<br>Score: ${rec.score}/100<br>${(rec.distance/1000).toFixed(2)} km, ${rec.eta.toFixed(2)} min<br><small style="color: #a0a0c0;">${rec.reasoning}</small>`);
                markers.push(m);
                if (i > 0) info += `<div class="info-item" style="font-size: 12px; padding: 10px; border-left-color: ${c};"><strong>${i+1}. ${rec.hospital.name}</strong><br>Score: ${rec.score} | ${(rec.distance/1000).toFixed(2)} km</div>`;
            });
            info += `<button onclick="routeToHospital(${best.hospital.lat}, ${best.hospital.lon}, '${best.hospital.name.replace(/'/g, "\\'")}')" style="width: 100%; padding: 14px; margin-top: 15px; background: linear-gradient(135deg, rgba(6, 255, 165, 0.8), rgba(58, 255, 200, 0.8)); border: none; border-radius: 12px; color: white; font-size: 15px; font-weight: 600; cursor: pointer;">üöë Route to ${best.hospital.name}</button>`;
            showInfo(info);
            const bounds = L.latLngBounds([[currentEmergencyLocation.lat, currentEmergencyLocation.lon]]);
            recs.forEach(r => bounds.extend([r.hospital.lat, r.hospital.lon]));
            map.fitBounds(bounds, {padding: [50, 50]});
        }
        
        async function routeToHospital(lat, lon, name) {
            showInfo('<div class="loading">Calculating route...</div>');
            try {
                const res = await fetch(`${API_URL}/route`, {method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({fromLat: currentEmergencyLocation.lat, fromLon: currentEmergencyLocation.lon, toLat: lat, toLon: lon})});
                const r = await res.json();
                if (!r.success) return showInfo('<h3>‚ùå Error</h3><div class="info-item">Route failed</div>');
                map.eachLayer(l => { if (l instanceof L.Polyline && l.options.color === '#E31E24') map.removeLayer(l); });
                const coords = r.path.map(p => [p.lat, p.lon]);
                routeLine = L.polyline(coords, {color: '#E31E24', weight: 5, opacity: 0.8}).addTo(map);
                animateToHospital(coords, r.time / 60.0, name);
                showInfo(`<h3>üöë Route to Hospital</h3><div class="info-item" style="background: rgba(227, 30, 36, 0.1); border-color: #E31E24;"><strong>${name}</strong><br>Distance: ${(r.distance/1000).toFixed(2)} km<br>Time: ${(r.time / 60.0).toFixed(2)} min</div><div class="info-item" style="background: rgba(6, 255, 165, 0.1); border-color: #06ffa5;">‚úì Transporting patient...</div>`);
                map.fitBounds(routeLine.getBounds(), {padding: [50, 50]});
            } catch (e) {
                showInfo('<h3>‚ùå Error</h3><div class="info-item">Failed</div>');
            }
        }
        
        function animateToHospital(coords, eta, name) {
            if (movingAmbulance) map.removeLayer(movingAmbulance);
            if (animationInterval) clearInterval(animationInterval);
            movingAmbulance = L.circleMarker(coords[0], {radius: 14, fillColor: '#06ffa5', color: '#fff', weight: 4, opacity: 1, fillOpacity: 1}).addTo(map);
            let idx = 0;
            const int = 15000 / coords.length;
            animationInterval = setInterval(() => {
                idx++;
                if (idx >= coords.length) {
                    clearInterval(animationInterval);
                    movingAmbulance.bindPopup(`<b style="color: #06ffa5;">üè• ARRIVED AT<br>${name}</b>`).openPopup();
                    showInfo(`<h3>‚úÖ Patient Delivered</h3><div class="info-item" style="background: rgba(6, 255, 165, 0.1); border-color: #06ffa5;"><strong>Successfully transported to:</strong><br>${name}<br><br>‚úì Emergency care in progress</div>`);
                    return;
                }
                movingAmbulance.setLatLng(coords[idx]);
            }, int);
        }
        
        function clearMap() {
            markers.forEach(m => map.removeLayer(m));
            markers = [];
            if (routeLine) { map.removeLayer(routeLine); routeLine = null; }
            if (movingAmbulance) { map.removeLayer(movingAmbulance); movingAmbulance = null; }
            if (animationInterval) { clearInterval(animationInterval); animationInterval = null; }
            map.eachLayer(l => { if (l instanceof L.Polyline && l.options.dashArray === '10, 10') map.removeLayer(l); });
            hideInfo();
        }
        
        function showInfo(html) {
            const panel = document.getElementById('info-panel');
            panel.innerHTML = `<button class="close-btn" onclick="hideInfo()">√ó</button>${html}`;
            panel.classList.add('active');
        }
        
        function hideInfo() { document.getElementById('info-panel').classList.remove('active'); }
        
        checkStatus();
        setInterval(checkStatus, 10000);
    </script>
</body>
</html>